# HTTP to HTTPS redirect
http://$VLESS_DOMAIN {
    bind 0.0.0.0
    redir https://$VLESS_DOMAIN{uri} permanent

    header {
            -Server
    }

    handle_errors {
            header {
                    -Server
            }
    }
}

https://$VLESS_DOMAIN {
    bind 0.0.0.0
    $CADDY_REVERSE

    header {
            -Server
    }

    handle_errors {
            header {
                    -Server
            }
    }

    tls {
        protocols tls1.2
    }

    # XRay proxying
    @xray_path {
        path /api/v1/synbomzha
    }

    reverse_proxy @xray_path 127.0.0.1:4123 {
        transport http {
            versions h2c
            read_timeout 315s
            write_timeout 300s
        }

        header_up X-Forwarded-For {remote_host}
    }
}
